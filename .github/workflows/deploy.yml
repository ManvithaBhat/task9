# File: .github/workflows/deploy-gke.yaml
name: Self-Hosted GKE Deploy Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
      GKE_ZONE: ${{ secrets.GKE_ZONE }}
      DOCKER_REPO: ${{ secrets.DOCKER_REPO }}
      IMAGE_TAG: ${{ github.sha }}
      NAMESPACE: default   # Change if you want a custom namespace

    steps:
    # 1️⃣ Checkout the repository
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2️⃣ Authenticate with GCP using GitHub secret
    - name: Authenticate GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    # 3️⃣ Set up Terraform
    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.6.3

    # 4️⃣ Terraform Init & Apply
    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan -out=tfplan

    - name: Terraform Apply
      run: terraform apply -auto-approve tfplan

    # 5️⃣ Configure kubectl for GKE
    - name: Get GKE Credentials
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE --project $PROJECT_ID

    # 6️⃣ Build and Push Docker Image
    - name: Build Docker Image
      run: |
        docker build -t $DOCKER_REPO:$IMAGE_TAG .
        docker push $DOCKER_REPO:$IMAGE_TAG

    # 7️⃣ Create namespace if it doesn't exist
    - name: Ensure Namespace Exists
      run: |
        kubectl get namespace $NAMESPACE || kubectl create namespace $NAMESPACE

    # 8️⃣ Deploy using Helm
    - name: Helm Upgrade / Install
      run: |
        helm upgrade --install my-app ./helm-chart \
          --namespace $NAMESPACE \
          --set image.repository=$DOCKER_REPO \
          --set image.tag=$IMAGE_TAG
